<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRM Player (Patched + Logs)</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.6.12/plyr.css" />
  <script src="https://cdn.plyr.io/3.6.12/plyr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dashjs@4.6.1/dist/dash.all.min.js"></script>
  <style>
    body { margin: 0; background: #000; color: #fff; }
    video { width: 100%; height: 100vh; }
    #logs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 30%;
      overflow: auto;
      background: rgba(0, 0, 0, 0.8);
      padding: 5px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <video id="video" controls crossorigin playsinline></video>
  <div id="logs"></div>
  <script>
    function log(msg) {
      console.log(msg);
      const logBox = document.getElementById("logs");
      const line = document.createElement("div");
      line.textContent = msg;
      logBox.appendChild(line);
      if (logBox.childNodes.length > 100) {
        logBox.removeChild(logBox.firstChild);
      }
    }

    async function initDRMPlayer() {
      const video = document.getElementById("video");
      const inputUrl = new URL(window.location.href).searchParams.get("url");

      if (!inputUrl) {
        alert("Missing ?url=");
        return;
      }
      log("URL param: " + inputUrl);

      const proxyPlayerUrl = "https://api.extractor.workers.dev/player?url=" + encodeURIComponent(inputUrl);
      log("Fetching: " + proxyPlayerUrl);

      try {
        const res = await fetch(proxyPlayerUrl);
        const html = await res.text();
        log("Fetched proxy page (length " + html.length + ")");

        const mpdMatch = html.match(/source = "(https:\/\/[^"]+\.mpd[^"]*)"/);
        const licenseMatch = html.match(/serverURL":\s*"([^"]+)"/);

        if (!mpdMatch || !licenseMatch) {
          log("Failed to extract .mpd or license URL");
          alert("Parsing failed");
          return;
        }

        const mpdUrl = mpdMatch[1];
        const licenseUrl = licenseMatch[1];
        log("MPD: " + mpdUrl);
        log("License: " + licenseUrl);

        const dash = dashjs.MediaPlayer().create();
        dash.initialize(video, mpdUrl, true);

        dash.setProtectionData({
          "com.widevine.alpha": { serverURL: licenseUrl }
        });

        dash.on(dashjs.MediaPlayer.events.KEY_SYSTEM_LICENSE_REQUESTED, () => {
          log("üîê License request triggered");
        });

        dash.on("error", e => {
          log("‚ùå DASH error: " + JSON.stringify(e));
        });

        new Plyr(video);
        log("‚úÖ Player initialized");

      } catch (err) {
        log("üí• Failed to fetch player or parse response: " + err);
        alert("Video load failed");
      }
    }

    document.addEventListener("DOMContentLoaded", initDRMPlayer);
  </script>
</body>
</html>
